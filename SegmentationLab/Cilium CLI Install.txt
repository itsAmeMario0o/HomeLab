# --- Step 1: Set the Cilium CLI version ---
# We'll set an environment variable for the version to keep the script clean.
echo "Setting Cilium CLI version..."
CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)

# --- Step 2: Download and verify the Cilium CLI binary ---
# We'll create a temporary directory and change into it to ensure all downloads
# and checksums happen in the correct place.
echo "Downloading and verifying Cilium CLI..."
mkdir -p /tmp/cilium-cli-install
cd /tmp/cilium-cli-install

# Download the CLI binary and its checksum file
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-amd64.tar.gz{,.sha256sum}

# Verify the download with the checksum
sha256sum --check cilium-linux-amd64.tar.gz.sha256sum

# --- Step 3: Extract and install the binary ---
# We use sudo to move the extracted binary to /usr/local/bin
echo "Extracting and installing Cilium CLI..."
sudo tar -C /usr/local/bin -xzvf cilium-linux-amd64.tar.gz

# --- Step 4: Clean up temporary files and return to the home directory ---
echo "Cleaning up temporary files..."
cd $HOME
rm -rf /tmp/cilium-cli-install

# --- Step 5: Verify the installation ---
echo "Verifying installation..."
cilium version
