# --- Step 0: Initialize Networking ---

sudo nano /etc/netplan/00-installer-config.yaml
network:
  version: 2
  ethernets:
    ens3:
      dhcp4: no
      addresses: [192.168.52.100/24]
      routes:
        - to: default
          via: 192.168.52.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]

Ctrl+O
Enter
Control+X
Enter

sudo netplan apply

ping 192.68.52.1
ping 8.8.8.8
ping google.com

resolvectl status

CHECK SWAPOFF! 

# --- Step 1: Initialize the Kubernetes Control Plane ---
# Replace `<CONTROL_PLANE_IP_ADDRESS>` with the static IP of your control plane node.
# The `--pod-network-cidr` is crucial for the CNI to allocate IPs to pods.
# We will use 10.244.0.0/16 which is a common default for many CNIs.
echo "Initializing the Kubernetes control plane..."

sudo kubeadm init --kubernetes-version 1.30.3 --apiserver-advertise-address=192.168.52.100 --pod-network-cidr=10.244.0.0/16

# --- Step 2: Configure kubectl for the Current User ---
# This allows you to interact with the cluster without using `sudo`.
echo "Configuring kubectl for the current user..."

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# --- Step 3: Save the Worker Node Join Command ---
# The `kubeadm init` command will output a `kubeadm join` command.
# It is critical that you copy and save this command, as you will need it
# to join your worker nodes to the cluster.

kubeadm join 192.168.52.100:6443 --token i5k50w.szd5dlcw7cx2tpyu --discovery-token-ca-cert-hash sha256:b48bb2385b2d9c4041f617fefd74c5d02206e48a635881cd86d347f0e55e596d

# --- Step 1: Download the Helm installation script ---
# This command downloads the latest Helm release.

curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# --- Step 2: Verify Helm Installation ---
# This command checks the installed version of Helm.

helm version

# --- Step 4: Install Cilium CNI with Helm ---
# Cilium is a powerful CNI. We'll install it using Helm.
# This assumes you have already installed Helm. If not, you'll need to do that first.
echo "Installing Cilium CNI with BGP configuration..."

# Add the Cilium Helm repository

helm repo add cilium https://helm.cilium.io/

# Update Helm repositories
helm repo update

sudo curl -o cilium-values.yaml https://github.com/itsAmeMario0o/HomeLab/blob/main/cilium-value.yaml

# --- YOU NEED 3 files to configure BGP CRDs - Cluster config, Peer config, Advertisement

See CiliumBGP 1,2,3

# Install Cilium using the values file
helm install cilium cilium/cilium --version 1.15.5 --namespace kube-system -f cilium-values.yaml --kubeconfig $HOME/.kube/config --set bgpControlPlane.enabled="true"

# Upgrade BGP Config
sudo helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values --set bgpControlPlane.enabled=true --set cilium.installCRDs=true --kubeconfig $HOME/.kube/config

# Download the BGP Config
sudo curl -o BGPPeeringPolicy.yaml https://raw.githubusercontent.com/itsAmeMario0o/HomeLab/refs/heads/main/BGPPeeringPolicy.yaml

kubectl apply -f BGPPeeringPolicy.yaml

# Check labels for NodeSelector
kubectl get nodes --show-labels

# Define label - rack
kubectl label node ubuntu rack=rack0 --overwrite